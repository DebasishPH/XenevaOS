; Listing generated by Microsoft (R) Optimizing Compiler Version 18.00.21005.1 

include listing.inc

INCLUDELIB LIBCMT
INCLUDELIB OLDNAMES

CONST	SEGMENT
$SG3018	DB	'Ethernet ARP : Packet received ', 0dH, 0aH, 00H
	ORG $+6
$SG3020	DB	'Ethernet IPv4: Packet received ', 0dH, 0aH, 00H
	ORG $+6
$SG3034	DB	'Ethernet setuped %d %s', 0dH, 0aH, 00H
	ORG $+7
$SG3035	DB	'HWFile -> %x %s', 0dH, 0aH, 00H
	ORG $+6
$SG3037	DB	'HWFile writing %x ', 0dH, 0aH, 00H
CONST	ENDS
PUBLIC	?AuEthernetSend@@YAXPEAX_KGPEAE@Z		; AuEthernetSend
PUBLIC	AuEthernetHandle
EXTRN	AuGetNetworkAdapterByType:PROC
EXTRN	kmalloc:PROC
EXTRN	kfree:PROC
EXTRN	memset:PROC
EXTRN	memcpy:PROC
EXTRN	SeTextOut:PROC
EXTRN	AuTextOut:PROC
pdata	SEGMENT
$pdata$?AuEthernetSend@@YAXPEAX_KGPEAE@Z DD imagerel $LN5
	DD	imagerel $LN5+352
	DD	imagerel $unwind$?AuEthernetSend@@YAXPEAX_KGPEAE@Z
$pdata$AuEthernetHandle DD imagerel $LN7
	DD	imagerel $LN7+103
	DD	imagerel $unwind$AuEthernetHandle
pdata	ENDS
xdata	SEGMENT
$unwind$?AuEthernetSend@@YAXPEAX_KGPEAE@Z DD 011901H
	DD	08219H
$unwind$AuEthernetHandle DD 010901H
	DD	06209H
xdata	ENDS
; Function compile flags: /Odtpy
; File e:\xeneva project\aurora\kernel\net\ethernet.cpp
_TEXT	SEGMENT
tv73 = 32
frame$ = 64
AuEthernetHandle PROC

; 38   : AU_EXTERN AU_EXPORT void AuEthernetHandle(Ethernet *frame) {

$LN7:
	mov	QWORD PTR [rsp+8], rcx
	sub	rsp, 56					; 00000038H

; 39   : 	switch (ntohs(frame->typeLen)) {

	mov	rax, QWORD PTR frame$[rsp]
	movzx	eax, WORD PTR [rax+12]
	and	eax, 255				; 000000ffH
	shl	eax, 8
	mov	rcx, QWORD PTR frame$[rsp]
	movzx	ecx, WORD PTR [rcx+12]
	and	ecx, 65280				; 0000ff00H
	sar	ecx, 8
	or	eax, ecx
	mov	DWORD PTR tv73[rsp], eax
	cmp	DWORD PTR tv73[rsp], 2048		; 00000800H
	je	SHORT $LN1@AuEthernet
	cmp	DWORD PTR tv73[rsp], 2054		; 00000806H
	je	SHORT $LN2@AuEthernet
	jmp	SHORT $LN3@AuEthernet
$LN2@AuEthernet:

; 40   : 	case ETHERNET_TYPE_ARP:
; 41   : 		SeTextOut("Ethernet ARP : Packet received \r\n");

	lea	rcx, OFFSET FLAT:$SG3018
	call	SeTextOut

; 42   : 		break;

	jmp	SHORT $LN3@AuEthernet
$LN1@AuEthernet:

; 43   : 	case ETHERNET_TYPE_IPV4:
; 44   : 		SeTextOut("Ethernet IPv4: Packet received \r\n");

	lea	rcx, OFFSET FLAT:$SG3020
	call	SeTextOut
$LN3@AuEthernet:

; 45   : 		break;
; 46   : 	}
; 47   : }

	add	rsp, 56					; 00000038H
	ret	0
AuEthernetHandle ENDP
_TEXT	ENDS
; Function compile flags: /Odtpy
; File e:\xeneva project\aurora\kernel\net\ethernet.cpp
_TEXT	SEGMENT
netadapt$ = 32
pacl$ = 40
totalSz$ = 48
src_mac$ = 56
data$ = 80
len$ = 88
type$ = 96
dest$ = 104
?AuEthernetSend@@YAXPEAX_KGPEAE@Z PROC			; AuEthernetSend

; 56   : void AuEthernetSend(void* data, size_t len, uint16_t type, uint8_t* dest) {

$LN5:
	mov	QWORD PTR [rsp+32], r9
	mov	WORD PTR [rsp+24], r8w
	mov	QWORD PTR [rsp+16], rdx
	mov	QWORD PTR [rsp+8], rcx
	sub	rsp, 72					; 00000048H

; 57   : 	AuNetAdapter* netadapt = AuGetNetworkAdapterByType(AUNET_HWTYPE_ETHERNET);

	mov	cl, 1
	call	AuGetNetworkAdapterByType
	mov	QWORD PTR netadapt$[rsp], rax

; 58   : 	if (!netadapt)

	cmp	QWORD PTR netadapt$[rsp], 0
	jne	SHORT $LN2@AuEthernet

; 59   : 		return;

	jmp	$LN3@AuEthernet
$LN2@AuEthernet:

; 60   : 	size_t totalSz = sizeof(Ethernet)+len;

	mov	rax, QWORD PTR len$[rsp]
	add	rax, 14
	mov	QWORD PTR totalSz$[rsp], rax

; 61   : 	Ethernet* pacl = (Ethernet*)kmalloc(totalSz);

	mov	ecx, DWORD PTR totalSz$[rsp]
	call	kmalloc
	mov	QWORD PTR pacl$[rsp], rax

; 62   : 	memset(pacl, 0, totalSz);

	mov	r8d, DWORD PTR totalSz$[rsp]
	xor	edx, edx
	mov	rcx, QWORD PTR pacl$[rsp]
	call	memset

; 63   : 	memcpy(pacl->dest, dest, 6);

	mov	rax, QWORD PTR pacl$[rsp]
	mov	r8d, 6
	mov	rdx, QWORD PTR dest$[rsp]
	mov	rcx, rax
	call	memcpy

; 64   : 	uint8_t *src_mac = netadapt->mac;

	mov	rax, QWORD PTR netadapt$[rsp]
	add	rax, 8
	mov	QWORD PTR src_mac$[rsp], rax

; 65   : 	memcpy(pacl->src, src_mac, 6);

	mov	rax, QWORD PTR pacl$[rsp]
	add	rax, 6
	mov	r8d, 6
	mov	rdx, QWORD PTR src_mac$[rsp]
	mov	rcx, rax
	call	memcpy

; 66   : 	pacl->typeLen = htons(type);

	movzx	eax, WORD PTR type$[rsp]
	and	eax, 255				; 000000ffH
	shl	eax, 8
	movzx	ecx, WORD PTR type$[rsp]
	and	ecx, 65280				; 0000ff00H
	sar	ecx, 8
	or	eax, ecx
	mov	rcx, QWORD PTR pacl$[rsp]
	mov	WORD PTR [rcx+12], ax

; 67   : 	memcpy(pacl->payload, data, len);

	mov	rax, QWORD PTR pacl$[rsp]
	add	rax, 14
	mov	r8, QWORD PTR len$[rsp]
	mov	rdx, QWORD PTR data$[rsp]
	mov	rcx, rax
	call	memcpy

; 68   : 	
; 69   : 	AuTextOut("Ethernet setuped %d %s\r\n", netadapt->type, netadapt->name);

	mov	rax, QWORD PTR netadapt$[rsp]
	mov	rcx, QWORD PTR netadapt$[rsp]
	movzx	ecx, BYTE PTR [rcx+14]
	mov	r8, rax
	mov	edx, ecx
	lea	rcx, OFFSET FLAT:$SG3034
	call	AuTextOut

; 70   : 	SeTextOut("HWFile -> %x %s\r\n", netadapt->NetWrite, netadapt->NetRead);

	mov	rax, QWORD PTR netadapt$[rsp]
	mov	r8, QWORD PTR [rax+23]
	mov	rax, QWORD PTR netadapt$[rsp]
	mov	rdx, QWORD PTR [rax+15]
	lea	rcx, OFFSET FLAT:$SG3035
	call	SeTextOut

; 71   : 	
; 72   : 	if (netadapt->NetWrite) {

	mov	rax, QWORD PTR netadapt$[rsp]
	cmp	QWORD PTR [rax+15], 0
	je	SHORT $LN1@AuEthernet

; 73   : 		SeTextOut("HWFile writing %x \r\n",netadapt->NetWrite);

	mov	rax, QWORD PTR netadapt$[rsp]
	mov	rdx, QWORD PTR [rax+15]
	lea	rcx, OFFSET FLAT:$SG3037
	call	SeTextOut

; 74   : 		netadapt->NetWrite((uint64_t*)pacl, totalSz);

	mov	edx, DWORD PTR totalSz$[rsp]
	mov	rcx, QWORD PTR pacl$[rsp]
	mov	rax, QWORD PTR netadapt$[rsp]
	call	QWORD PTR [rax+15]
$LN1@AuEthernet:

; 75   : 	}
; 76   : 	kfree(pacl);

	mov	rcx, QWORD PTR pacl$[rsp]
	call	kfree
$LN3@AuEthernet:

; 77   : }

	add	rsp, 72					; 00000048H
	ret	0
?AuEthernetSend@@YAXPEAX_KGPEAE@Z ENDP			; AuEthernetSend
_TEXT	ENDS
END
