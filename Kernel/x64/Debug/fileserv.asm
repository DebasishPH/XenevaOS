; Listing generated by Microsoft (R) Optimizing Compiler Version 18.00.21005.1 

include listing.inc

INCLUDELIB LIBCMT
INCLUDELIB OLDNAMES

PUBLIC	?OpenFile@@YAHPEADH@Z				; OpenFile
PUBLIC	?ReadFile@@YA_KHPEAX_K@Z			; ReadFile
PUBLIC	?WriteFile@@YA_KHPEAX_K@Z			; WriteFile
PUBLIC	?CreateDir@@YAHPEAD@Z				; CreateDir
PUBLIC	?RemoveFile@@YAHPEAD@Z				; RemoveFile
PUBLIC	?CloseFile@@YAHH@Z				; CloseFile
PUBLIC	?FileIoControl@@YAHHHPEAX@Z			; FileIoControl
PUBLIC	?FileStat@@YAHHPEAX@Z				; FileStat
EXTRN	AuVFSOpen:PROC
EXTRN	AuVFSNodeIOControl:PROC
EXTRN	AuVFSFind:PROC
EXTRN	AuVFSNodeRead:PROC
EXTRN	AuVFSCreateDir:PROC
EXTRN	AuVFSCreateFile:PROC
EXTRN	?AuVFSRemoveFile@@YAHPEAU__VFS_NODE__@@0@Z:PROC	; AuVFSRemoveFile
EXTRN	?AuVFSRemoveDir@@YAHPEAU__VFS_NODE__@@0@Z:PROC	; AuVFSRemoveDir
EXTRN	AuVFSNodeWrite:PROC
EXTRN	AuGetCurrentThread:PROC
EXTRN	AuPmmngrAlloc:PROC
EXTRN	AuPmmngrFree:PROC
EXTRN	P2V:PROC
EXTRN	V2P:PROC
EXTRN	kfree:PROC
EXTRN	?AuProcessFindThread@@YAPEAU_au_proc_@@PEAU_au_thread_@@@Z:PROC ; AuProcessFindThread
EXTRN	?AuProcessFindSubThread@@YAPEAU_au_proc_@@PEAU_au_thread_@@@Z:PROC ; AuProcessFindSubThread
EXTRN	?AuProcessGetFileDesc@@YAHPEAU_au_proc_@@@Z:PROC ; AuProcessGetFileDesc
EXTRN	memset:PROC
EXTRN	memcpy:PROC
EXTRN	x64_cli:PROC
pdata	SEGMENT
$pdata$?OpenFile@@YAHPEADH@Z DD imagerel $LN12
	DD	imagerel $LN12+260
	DD	imagerel $unwind$?OpenFile@@YAHPEADH@Z
$pdata$?ReadFile@@YA_KHPEAX_K@Z DD imagerel $LN15
	DD	imagerel $LN15+396
	DD	imagerel $unwind$?ReadFile@@YA_KHPEAX_K@Z
$pdata$?WriteFile@@YA_KHPEAX_K@Z DD imagerel $LN13
	DD	imagerel $LN13+402
	DD	imagerel $unwind$?WriteFile@@YA_KHPEAX_K@Z
$pdata$?CreateDir@@YAHPEAD@Z DD imagerel $LN9
	DD	imagerel $LN9+182
	DD	imagerel $unwind$?CreateDir@@YAHPEAD@Z
$pdata$?RemoveFile@@YAHPEAD@Z DD imagerel $LN6
	DD	imagerel $LN6+108
	DD	imagerel $unwind$?RemoveFile@@YAHPEAD@Z
$pdata$?CloseFile@@YAHH@Z DD imagerel $LN9
	DD	imagerel $LN9+198
	DD	imagerel $unwind$?CloseFile@@YAHH@Z
$pdata$?FileIoControl@@YAHHHPEAX@Z DD imagerel $LN8
	DD	imagerel $LN8+189
	DD	imagerel $unwind$?FileIoControl@@YAHHHPEAX@Z
$pdata$?FileStat@@YAHHPEAX@Z DD imagerel $LN8
	DD	imagerel $LN8+274
	DD	imagerel $unwind$?FileStat@@YAHHPEAX@Z
pdata	ENDS
xdata	SEGMENT
$unwind$?OpenFile@@YAHPEADH@Z DD 010d01H
	DD	0a20dH
$unwind$?ReadFile@@YA_KHPEAX_K@Z DD 011201H
	DD	0a212H
$unwind$?WriteFile@@YA_KHPEAX_K@Z DD 011201H
	DD	0c212H
$unwind$?CreateDir@@YAHPEAD@Z DD 010901H
	DD	08209H
$unwind$?RemoveFile@@YAHPEAD@Z DD 010901H
	DD	06209H
$unwind$?CloseFile@@YAHH@Z DD 010801H
	DD	08208H
$unwind$?FileIoControl@@YAHHHPEAX@Z DD 011101H
	DD	08211H
$unwind$?FileStat@@YAHHPEAX@Z DD 010d01H
	DD	0820dH
xdata	ENDS
; Function compile flags: /Odtpy
; File e:\xeneva project\aurora\kernel\serv\fileserv.cpp
_TEXT	SEGMENT
status$ = 32
file$ = 40
current_proc$ = 48
current_thr$ = 56
fd$ = 80
buf$ = 88
?FileStat@@YAHHPEAX@Z PROC				; FileStat

; 290  : int FileStat(int fd, void* buf) {

$LN8:
	mov	QWORD PTR [rsp+16], rdx
	mov	DWORD PTR [rsp+8], ecx
	sub	rsp, 72					; 00000048H

; 291  : 	x64_cli();

	call	x64_cli

; 292  : 	if (fd == -1)

	cmp	DWORD PTR fd$[rsp], -1
	jne	SHORT $LN5@FileStat

; 293  : 		return -1;

	mov	eax, -1
	jmp	$LN6@FileStat
$LN5@FileStat:

; 294  : 	AuThread* current_thr = AuGetCurrentThread();

	call	AuGetCurrentThread
	mov	QWORD PTR current_thr$[rsp], rax

; 295  : 	if (!current_thr){

	cmp	QWORD PTR current_thr$[rsp], 0
	jne	SHORT $LN4@FileStat

; 296  : 		return 0;

	xor	eax, eax
	jmp	$LN6@FileStat
$LN4@FileStat:

; 297  : 	}
; 298  : 	AuProcess* current_proc = AuProcessFindThread(current_thr);

	mov	rcx, QWORD PTR current_thr$[rsp]
	call	?AuProcessFindThread@@YAPEAU_au_proc_@@PEAU_au_thread_@@@Z ; AuProcessFindThread
	mov	QWORD PTR current_proc$[rsp], rax

; 299  : 	if (!current_proc) {

	cmp	QWORD PTR current_proc$[rsp], 0
	jne	SHORT $LN3@FileStat

; 300  : 		current_proc = AuProcessFindSubThread(current_thr);

	mov	rcx, QWORD PTR current_thr$[rsp]
	call	?AuProcessFindSubThread@@YAPEAU_au_proc_@@PEAU_au_thread_@@@Z ; AuProcessFindSubThread
	mov	QWORD PTR current_proc$[rsp], rax

; 301  : 		if (!current_proc)

	cmp	QWORD PTR current_proc$[rsp], 0
	jne	SHORT $LN2@FileStat

; 302  : 			return 0;

	xor	eax, eax
	jmp	$LN6@FileStat
$LN2@FileStat:
$LN3@FileStat:

; 303  : 	}
; 304  : 	AuVFSNode* file = current_proc->fds[fd];

	movsxd	rax, DWORD PTR fd$[rsp]
	mov	rcx, QWORD PTR current_proc$[rsp]
	mov	rax, QWORD PTR [rcx+rax*8+576]
	mov	QWORD PTR file$[rsp], rax

; 305  : 	if (!file)

	cmp	QWORD PTR file$[rsp], 0
	jne	SHORT $LN1@FileStat

; 306  : 		return -1;

	mov	eax, -1
	jmp	SHORT $LN6@FileStat
$LN1@FileStat:

; 307  : 
; 308  : 	AuFileStatus *status = (AuFileStatus*)buf;

	mov	rax, QWORD PTR buf$[rsp]
	mov	QWORD PTR status$[rsp], rax

; 309  : 	status->current_block = file->current;

	mov	rax, QWORD PTR status$[rsp]
	mov	rcx, QWORD PTR file$[rsp]
	mov	ecx, DWORD PTR [rcx+56]
	mov	DWORD PTR [rax+9], ecx

; 310  : 	status->size = file->size;

	mov	rax, QWORD PTR file$[rsp]
	mov	eax, DWORD PTR [rax+32]
	mov	rcx, QWORD PTR status$[rsp]
	mov	QWORD PTR [rcx+1], rax

; 311  : 	status->filemode = file->flags;

	mov	rax, QWORD PTR status$[rsp]
	mov	rcx, QWORD PTR file$[rsp]
	movzx	ecx, BYTE PTR [rcx+64]
	mov	BYTE PTR [rax], cl

; 312  : 	status->eof = file->eof;

	mov	rax, QWORD PTR status$[rsp]
	mov	rcx, QWORD PTR file$[rsp]
	movzx	ecx, BYTE PTR [rcx+36]
	mov	BYTE PTR [rax+29], cl

; 313  : 	status->start_block = file->first_block;

	mov	rax, QWORD PTR status$[rsp]
	mov	rcx, QWORD PTR file$[rsp]
	mov	ecx, DWORD PTR [rcx+48]
	mov	DWORD PTR [rax+13], ecx

; 314  : 	status->user_id = 0;

	mov	rax, QWORD PTR status$[rsp]
	mov	DWORD PTR [rax+17], 0

; 315  : 	status->group_id = 0;

	mov	rax, QWORD PTR status$[rsp]
	mov	DWORD PTR [rax+21], 0

; 316  : 	return 0;

	xor	eax, eax
$LN6@FileStat:

; 317  : }

	add	rsp, 72					; 00000048H
	ret	0
?FileStat@@YAHHPEAX@Z ENDP				; FileStat
_TEXT	ENDS
; Function compile flags: /Odtpy
; File e:\xeneva project\aurora\kernel\serv\fileserv.cpp
_TEXT	SEGMENT
ret$ = 32
current_proc$ = 40
current_thr$ = 48
file$ = 56
fd$ = 80
code$ = 88
arg$ = 96
?FileIoControl@@YAHHHPEAX@Z PROC			; FileIoControl

; 261  : int FileIoControl(int fd, int code, void* arg) {

$LN8:
	mov	QWORD PTR [rsp+24], r8
	mov	DWORD PTR [rsp+16], edx
	mov	DWORD PTR [rsp+8], ecx
	sub	rsp, 72					; 00000048H

; 262  : 	x64_cli();

	call	x64_cli

; 263  : 	if (fd == -1)

	cmp	DWORD PTR fd$[rsp], -1
	jne	SHORT $LN5@FileIoCont

; 264  : 		return -1;

	mov	eax, -1
	jmp	$LN6@FileIoCont
$LN5@FileIoCont:

; 265  : 	AuThread* current_thr = AuGetCurrentThread();

	call	AuGetCurrentThread
	mov	QWORD PTR current_thr$[rsp], rax

; 266  : 	if (!current_thr)

	cmp	QWORD PTR current_thr$[rsp], 0
	jne	SHORT $LN4@FileIoCont

; 267  : 		return 0;

	xor	eax, eax
	jmp	SHORT $LN6@FileIoCont
$LN4@FileIoCont:

; 268  : 	AuProcess* current_proc = AuProcessFindThread(current_thr);

	mov	rcx, QWORD PTR current_thr$[rsp]
	call	?AuProcessFindThread@@YAPEAU_au_proc_@@PEAU_au_thread_@@@Z ; AuProcessFindThread
	mov	QWORD PTR current_proc$[rsp], rax

; 269  : 	if (!current_proc) {

	cmp	QWORD PTR current_proc$[rsp], 0
	jne	SHORT $LN3@FileIoCont

; 270  : 		current_proc = AuProcessFindSubThread(current_thr);

	mov	rcx, QWORD PTR current_thr$[rsp]
	call	?AuProcessFindSubThread@@YAPEAU_au_proc_@@PEAU_au_thread_@@@Z ; AuProcessFindSubThread
	mov	QWORD PTR current_proc$[rsp], rax

; 271  : 		if (!current_proc)

	cmp	QWORD PTR current_proc$[rsp], 0
	jne	SHORT $LN2@FileIoCont

; 272  : 			return 0;

	xor	eax, eax
	jmp	SHORT $LN6@FileIoCont
$LN2@FileIoCont:
$LN3@FileIoCont:

; 273  : 	}
; 274  : 	AuVFSNode* file = current_proc->fds[fd];

	movsxd	rax, DWORD PTR fd$[rsp]
	mov	rcx, QWORD PTR current_proc$[rsp]
	mov	rax, QWORD PTR [rcx+rax*8+576]
	mov	QWORD PTR file$[rsp], rax

; 275  : 
; 276  : 	if (!file)

	cmp	QWORD PTR file$[rsp], 0
	jne	SHORT $LN1@FileIoCont

; 277  : 		return -1;

	mov	eax, -1
	jmp	SHORT $LN6@FileIoCont
$LN1@FileIoCont:

; 278  : 
; 279  : 	int ret = 0;

	mov	DWORD PTR ret$[rsp], 0

; 280  : 	ret = AuVFSNodeIOControl(file, code, arg);

	mov	r8, QWORD PTR arg$[rsp]
	mov	edx, DWORD PTR code$[rsp]
	mov	rcx, QWORD PTR file$[rsp]
	call	AuVFSNodeIOControl
	mov	DWORD PTR ret$[rsp], eax

; 281  : 	return ret;

	mov	eax, DWORD PTR ret$[rsp]
$LN6@FileIoCont:

; 282  : }

	add	rsp, 72					; 00000048H
	ret	0
?FileIoControl@@YAHHHPEAX@Z ENDP			; FileIoControl
_TEXT	ENDS
; Function compile flags: /Odtpy
; File e:\xeneva project\aurora\kernel\serv\fileserv.cpp
_TEXT	SEGMENT
current_proc$ = 32
current_thr$ = 40
file$ = 48
fd$ = 80
?CloseFile@@YAHH@Z PROC					; CloseFile

; 232  : int CloseFile(int fd) {

$LN9:
	mov	DWORD PTR [rsp+8], ecx
	sub	rsp, 72					; 00000048H

; 233  : 	if (fd == -1)

	cmp	DWORD PTR fd$[rsp], -1
	jne	SHORT $LN6@CloseFile

; 234  : 		return 0;

	xor	eax, eax
	jmp	$LN7@CloseFile
$LN6@CloseFile:

; 235  : 	AuThread* current_thr = AuGetCurrentThread();

	call	AuGetCurrentThread
	mov	QWORD PTR current_thr$[rsp], rax

; 236  : 	if (!current_thr)

	cmp	QWORD PTR current_thr$[rsp], 0
	jne	SHORT $LN5@CloseFile

; 237  : 		return 0;

	xor	eax, eax
	jmp	$LN7@CloseFile
$LN5@CloseFile:

; 238  : 	AuProcess* current_proc = AuProcessFindThread(current_thr);

	mov	rcx, QWORD PTR current_thr$[rsp]
	call	?AuProcessFindThread@@YAPEAU_au_proc_@@PEAU_au_thread_@@@Z ; AuProcessFindThread
	mov	QWORD PTR current_proc$[rsp], rax

; 239  : 	if (!current_proc) {

	cmp	QWORD PTR current_proc$[rsp], 0
	jne	SHORT $LN4@CloseFile

; 240  : 		current_proc = AuProcessFindSubThread(current_thr);

	mov	rcx, QWORD PTR current_thr$[rsp]
	call	?AuProcessFindSubThread@@YAPEAU_au_proc_@@PEAU_au_thread_@@@Z ; AuProcessFindSubThread
	mov	QWORD PTR current_proc$[rsp], rax

; 241  : 		if (!current_proc)

	cmp	QWORD PTR current_proc$[rsp], 0
	jne	SHORT $LN3@CloseFile

; 242  : 			return 0;

	xor	eax, eax
	jmp	SHORT $LN7@CloseFile
$LN3@CloseFile:
$LN4@CloseFile:

; 243  : 	}
; 244  : 
; 245  : 	AuVFSNode* file = current_proc->fds[fd];

	movsxd	rax, DWORD PTR fd$[rsp]
	mov	rcx, QWORD PTR current_proc$[rsp]
	mov	rax, QWORD PTR [rcx+rax*8+576]
	mov	QWORD PTR file$[rsp], rax

; 246  : 	if (file->flags & FS_FLAG_FILE_SYSTEM)

	mov	rax, QWORD PTR file$[rsp]
	movzx	eax, WORD PTR [rax+64]
	and	eax, 64					; 00000040H
	test	eax, eax
	je	SHORT $LN2@CloseFile

; 247  : 		return -1;

	mov	eax, -1
	jmp	SHORT $LN7@CloseFile
$LN2@CloseFile:

; 248  : 	if (file->flags & FS_FLAG_GENERAL)

	mov	rax, QWORD PTR file$[rsp]
	movzx	eax, WORD PTR [rax+64]
	and	eax, 4
	test	eax, eax
	je	SHORT $LN1@CloseFile

; 249  : 		kfree(file);

	mov	rcx, QWORD PTR file$[rsp]
	call	kfree
$LN1@CloseFile:

; 250  : 
; 251  : 	current_proc->fds[fd] = 0;

	movsxd	rax, DWORD PTR fd$[rsp]
	mov	rcx, QWORD PTR current_proc$[rsp]
	mov	QWORD PTR [rcx+rax*8+576], 0

; 252  : 	return 0;

	xor	eax, eax
$LN7@CloseFile:

; 253  : }

	add	rsp, 72					; 00000048H
	ret	0
?CloseFile@@YAHH@Z ENDP					; CloseFile
_TEXT	ENDS
; Function compile flags: /Odtpy
; File e:\xeneva project\aurora\kernel\serv\fileserv.cpp
_TEXT	SEGMENT
dir$ = 32
fsys$ = 40
pathname$ = 64
?RemoveFile@@YAHPEAD@Z PROC				; RemoveFile

; 217  : int RemoveFile(char* pathname) {

$LN6:
	mov	QWORD PTR [rsp+8], rcx
	sub	rsp, 56					; 00000038H

; 218  : 	AuVFSNode* dir = AuVFSOpen(pathname);

	mov	rcx, QWORD PTR pathname$[rsp]
	call	AuVFSOpen
	mov	QWORD PTR dir$[rsp], rax

; 219  : 	if (!dir)

	cmp	QWORD PTR dir$[rsp], 0
	jne	SHORT $LN3@RemoveFile

; 220  : 		return -1;

	mov	eax, -1
	jmp	SHORT $LN4@RemoveFile
$LN3@RemoveFile:

; 221  : 	AuVFSNode* fsys = (AuVFSNode*)dir->device;

	mov	rax, QWORD PTR dir$[rsp]
	mov	rax, QWORD PTR [rax+72]
	mov	QWORD PTR fsys$[rsp], rax

; 222  : 	if (fsys->flags & FS_FLAG_DIRECTORY)

	mov	rax, QWORD PTR fsys$[rsp]
	movzx	eax, WORD PTR [rax+64]
	and	eax, 2
	test	eax, eax
	je	SHORT $LN2@RemoveFile

; 223  : 		return AuVFSRemoveDir(fsys, dir);

	mov	rdx, QWORD PTR dir$[rsp]
	mov	rcx, QWORD PTR fsys$[rsp]
	call	?AuVFSRemoveDir@@YAHPEAU__VFS_NODE__@@0@Z ; AuVFSRemoveDir
	jmp	SHORT $LN4@RemoveFile

; 224  : 	else

	jmp	SHORT $LN1@RemoveFile
$LN2@RemoveFile:

; 225  : 		return AuVFSRemoveFile(fsys, dir);

	mov	rdx, QWORD PTR dir$[rsp]
	mov	rcx, QWORD PTR fsys$[rsp]
	call	?AuVFSRemoveFile@@YAHPEAU__VFS_NODE__@@0@Z ; AuVFSRemoveFile
$LN1@RemoveFile:
$LN4@RemoveFile:

; 226  : }

	add	rsp, 56					; 00000038H
	ret	0
?RemoveFile@@YAHPEAD@Z ENDP				; RemoveFile
_TEXT	ENDS
; Function compile flags: /Odtpy
; File e:\xeneva project\aurora\kernel\serv\fileserv.cpp
_TEXT	SEGMENT
current_thr$ = 32
current_proc$ = 40
dirfile$ = 48
fsys$ = 56
filename$ = 80
?CreateDir@@YAHPEAD@Z PROC				; CreateDir

; 183  : int CreateDir(char* filename) {

$LN9:
	mov	QWORD PTR [rsp+8], rcx
	sub	rsp, 72					; 00000048H

; 184  : 	x64_cli();

	call	x64_cli

; 185  : 	AuThread* current_thr = AuGetCurrentThread();

	call	AuGetCurrentThread
	mov	QWORD PTR current_thr$[rsp], rax

; 186  : 	if (!current_thr){

	cmp	QWORD PTR current_thr$[rsp], 0
	jne	SHORT $LN6@CreateDir

; 187  : 		return 0;

	xor	eax, eax
	jmp	$LN7@CreateDir
$LN6@CreateDir:

; 188  : 	}
; 189  : 	AuProcess* current_proc = AuProcessFindThread(current_thr);

	mov	rcx, QWORD PTR current_thr$[rsp]
	call	?AuProcessFindThread@@YAPEAU_au_proc_@@PEAU_au_thread_@@@Z ; AuProcessFindThread
	mov	QWORD PTR current_proc$[rsp], rax

; 190  : 	if (!current_proc) {

	cmp	QWORD PTR current_proc$[rsp], 0
	jne	SHORT $LN5@CreateDir

; 191  : 		current_proc = AuProcessFindSubThread(current_thr);

	mov	rcx, QWORD PTR current_thr$[rsp]
	call	?AuProcessFindSubThread@@YAPEAU_au_proc_@@PEAU_au_thread_@@@Z ; AuProcessFindSubThread
	mov	QWORD PTR current_proc$[rsp], rax

; 192  : 		if (!current_proc)

	cmp	QWORD PTR current_proc$[rsp], 0
	jne	SHORT $LN4@CreateDir

; 193  : 			return 0;

	xor	eax, eax
	jmp	SHORT $LN7@CreateDir
$LN4@CreateDir:
$LN5@CreateDir:

; 194  : 	}
; 195  : 
; 196  : 	AuVFSNode *fsys = AuVFSFind(filename);

	mov	rcx, QWORD PTR filename$[rsp]
	call	AuVFSFind
	mov	QWORD PTR fsys$[rsp], rax

; 197  : 	AuVFSNode* dirfile = NULL;

	mov	QWORD PTR dirfile$[rsp], 0

; 198  : 	if (fsys){

	cmp	QWORD PTR fsys$[rsp], 0
	je	SHORT $LN3@CreateDir

; 199  : 		dirfile = AuVFSCreateDir(fsys, filename);

	mov	rdx, QWORD PTR filename$[rsp]
	mov	rcx, QWORD PTR fsys$[rsp]
	call	AuVFSCreateDir
	mov	QWORD PTR dirfile$[rsp], rax

; 200  : 	}
; 201  : 	else {

	jmp	SHORT $LN2@CreateDir
$LN3@CreateDir:

; 202  : 		return -1;

	mov	eax, -1
	jmp	SHORT $LN7@CreateDir
$LN2@CreateDir:

; 203  : 	}
; 204  : 
; 205  : 	if (dirfile) {

	cmp	QWORD PTR dirfile$[rsp], 0
	je	SHORT $LN1@CreateDir

; 206  : 		kfree(dirfile);

	mov	rcx, QWORD PTR dirfile$[rsp]
	call	kfree

; 207  : 		return 0;

	xor	eax, eax
	jmp	SHORT $LN7@CreateDir
$LN1@CreateDir:

; 208  : 	}
; 209  : 
; 210  : 	return -1;

	mov	eax, -1
$LN7@CreateDir:

; 211  : }

	add	rsp, 72					; 00000048H
	ret	0
?CreateDir@@YAHPEAD@Z ENDP				; CreateDir
_TEXT	ENDS
; Function compile flags: /Odtpy
; File e:\xeneva project\aurora\kernel\serv\fileserv.cpp
_TEXT	SEGMENT
file$ = 32
current_proc$ = 40
buff$1 = 48
current_thr$ = 56
fsys$ = 64
aligned_buffer$ = 72
write_bytes$ = 80
fd$ = 112
buffer$ = 120
length$ = 128
?WriteFile@@YA_KHPEAX_K@Z PROC				; WriteFile

; 137  : size_t WriteFile(int fd, void* buffer, size_t length) {

$LN13:
	mov	QWORD PTR [rsp+24], r8
	mov	QWORD PTR [rsp+16], rdx
	mov	DWORD PTR [rsp+8], ecx
	sub	rsp, 104				; 00000068H

; 138  : 	x64_cli();

	call	x64_cli

; 139  : 	if (fd == -1)

	cmp	DWORD PTR fd$[rsp], -1
	jne	SHORT $LN10@WriteFile

; 140  : 		return 0;

	xor	eax, eax
	jmp	$LN11@WriteFile
$LN10@WriteFile:

; 141  : 	if (!buffer)

	cmp	QWORD PTR buffer$[rsp], 0
	jne	SHORT $LN9@WriteFile

; 142  : 		return 0;

	xor	eax, eax
	jmp	$LN11@WriteFile
$LN9@WriteFile:

; 143  : 	if (!length)

	cmp	QWORD PTR length$[rsp], 0
	jne	SHORT $LN8@WriteFile

; 144  : 		return 0;

	xor	eax, eax
	jmp	$LN11@WriteFile
$LN8@WriteFile:

; 145  : 	AuThread* current_thr = AuGetCurrentThread();

	call	AuGetCurrentThread
	mov	QWORD PTR current_thr$[rsp], rax

; 146  : 	if (!current_thr)

	cmp	QWORD PTR current_thr$[rsp], 0
	jne	SHORT $LN7@WriteFile

; 147  : 		return 0;

	xor	eax, eax
	jmp	$LN11@WriteFile
$LN7@WriteFile:

; 148  : 	AuProcess* current_proc = AuProcessFindThread(current_thr);

	mov	rcx, QWORD PTR current_thr$[rsp]
	call	?AuProcessFindThread@@YAPEAU_au_proc_@@PEAU_au_thread_@@@Z ; AuProcessFindThread
	mov	QWORD PTR current_proc$[rsp], rax

; 149  : 	if (!current_proc) {

	cmp	QWORD PTR current_proc$[rsp], 0
	jne	SHORT $LN6@WriteFile

; 150  : 		current_proc = AuProcessFindSubThread(current_thr);

	mov	rcx, QWORD PTR current_thr$[rsp]
	call	?AuProcessFindSubThread@@YAPEAU_au_proc_@@PEAU_au_thread_@@@Z ; AuProcessFindSubThread
	mov	QWORD PTR current_proc$[rsp], rax

; 151  : 		if (!current_proc) 

	cmp	QWORD PTR current_proc$[rsp], 0
	jne	SHORT $LN5@WriteFile

; 152  : 			return 0;

	xor	eax, eax
	jmp	$LN11@WriteFile
$LN5@WriteFile:
$LN6@WriteFile:

; 153  : 	}
; 154  : 	AuVFSNode* file = current_proc->fds[fd];

	movsxd	rax, DWORD PTR fd$[rsp]
	mov	rcx, QWORD PTR current_proc$[rsp]
	mov	rax, QWORD PTR [rcx+rax*8+576]
	mov	QWORD PTR file$[rsp], rax

; 155  : 	uint8_t* aligned_buffer = (uint8_t*)buffer;

	mov	rax, QWORD PTR buffer$[rsp]
	mov	QWORD PTR aligned_buffer$[rsp], rax

; 156  : 
; 157  : 	if (!file)

	cmp	QWORD PTR file$[rsp], 0
	jne	SHORT $LN4@WriteFile

; 158  : 		return 0;

	xor	eax, eax
	jmp	$LN11@WriteFile
$LN4@WriteFile:

; 159  : 	size_t write_bytes = 0;

	mov	QWORD PTR write_bytes$[rsp], 0

; 160  : 	size_t ret_bytes;
; 161  : 	/* every general file will contain its
; 162  : 	* file system node as device */
; 163  : 	AuVFSNode* fsys = (AuVFSNode*)file->device;

	mov	rax, QWORD PTR file$[rsp]
	mov	rax, QWORD PTR [rax+72]
	mov	QWORD PTR fsys$[rsp], rax

; 164  : 	if (file->flags & FS_FLAG_GENERAL) {

	mov	rax, QWORD PTR file$[rsp]
	movzx	eax, WORD PTR [rax+64]
	and	eax, 4
	test	eax, eax
	je	SHORT $LN3@WriteFile

; 165  : 		uint64_t* buff = (uint64_t*)P2V((size_t)AuPmmngrAlloc());

	call	AuPmmngrAlloc
	mov	rcx, rax
	call	P2V
	mov	QWORD PTR buff$1[rsp], rax

; 166  : 		memset(buff, 0, PAGE_SIZE);

	mov	r8d, 4096				; 00001000H
	xor	edx, edx
	mov	rcx, QWORD PTR buff$1[rsp]
	call	memset

; 167  : 		memcpy(buff,aligned_buffer, PAGE_SIZE);

	mov	r8d, 4096				; 00001000H
	mov	rdx, QWORD PTR aligned_buffer$[rsp]
	mov	rcx, QWORD PTR buff$1[rsp]
	call	memcpy

; 168  : 		AuVFSNodeWrite(fsys, file, buff, length);

	mov	r9d, DWORD PTR length$[rsp]
	mov	r8, QWORD PTR buff$1[rsp]
	mov	rdx, QWORD PTR file$[rsp]
	mov	rcx, QWORD PTR fsys$[rsp]
	call	AuVFSNodeWrite

; 169  : 		AuPmmngrFree((void*)V2P((size_t)buff));

	mov	rcx, QWORD PTR buff$1[rsp]
	call	V2P
	mov	rcx, rax
	call	AuPmmngrFree
$LN3@WriteFile:

; 170  : 	}
; 171  : 
; 172  : 	if (file->flags & FS_FLAG_DEVICE) {

	mov	rax, QWORD PTR file$[rsp]
	movzx	eax, WORD PTR [rax+64]
	and	eax, 8
	test	eax, eax
	je	SHORT $LN2@WriteFile

; 173  : 		if (file->write) {

	mov	rax, QWORD PTR file$[rsp]
	cmp	QWORD PTR [rax+96], 0
	je	SHORT $LN1@WriteFile

; 174  : 			file->write(fsys, file, (uint64_t*)buffer, length);

	mov	r9d, DWORD PTR length$[rsp]
	mov	r8, QWORD PTR buffer$[rsp]
	mov	rdx, QWORD PTR file$[rsp]
	mov	rcx, QWORD PTR fsys$[rsp]
	mov	rax, QWORD PTR file$[rsp]
	call	QWORD PTR [rax+96]
$LN1@WriteFile:
$LN2@WriteFile:
$LN11@WriteFile:

; 175  : 		}
; 176  : 	}
; 177  : }

	add	rsp, 104				; 00000068H
	ret	0
?WriteFile@@YA_KHPEAX_K@Z ENDP				; WriteFile
_TEXT	ENDS
; Function compile flags: /Odtpy
; File e:\xeneva project\aurora\kernel\serv\fileserv.cpp
_TEXT	SEGMENT
file$ = 32
current_proc$ = 40
ret_bytes$ = 48
current_thr$ = 56
aligned_buffer$ = 64
fsys$ = 72
fd$ = 96
buffer$ = 104
length$ = 112
?ReadFile@@YA_KHPEAX_K@Z PROC				; ReadFile

; 87   : size_t ReadFile(int fd, void* buffer, size_t length) {

$LN15:
	mov	QWORD PTR [rsp+24], r8
	mov	QWORD PTR [rsp+16], rdx
	mov	DWORD PTR [rsp+8], ecx
	sub	rsp, 88					; 00000058H

; 88   : 	x64_cli();

	call	x64_cli

; 89   : 	if (fd == -1)

	cmp	DWORD PTR fd$[rsp], -1
	jne	SHORT $LN12@ReadFile

; 90   : 		return 0;

	xor	eax, eax
	jmp	$LN13@ReadFile
$LN12@ReadFile:

; 91   : 	if (!buffer)

	cmp	QWORD PTR buffer$[rsp], 0
	jne	SHORT $LN11@ReadFile

; 92   : 		return 0;

	xor	eax, eax
	jmp	$LN13@ReadFile
$LN11@ReadFile:

; 93   : 	if (!length)

	cmp	QWORD PTR length$[rsp], 0
	jne	SHORT $LN10@ReadFile

; 94   : 		return 0;

	xor	eax, eax
	jmp	$LN13@ReadFile
$LN10@ReadFile:

; 95   : 	AuThread* current_thr = AuGetCurrentThread();

	call	AuGetCurrentThread
	mov	QWORD PTR current_thr$[rsp], rax

; 96   : 	if (!current_thr)

	cmp	QWORD PTR current_thr$[rsp], 0
	jne	SHORT $LN9@ReadFile

; 97   : 		return 0;

	xor	eax, eax
	jmp	$LN13@ReadFile
$LN9@ReadFile:

; 98   : 	AuProcess* current_proc = AuProcessFindThread(current_thr);

	mov	rcx, QWORD PTR current_thr$[rsp]
	call	?AuProcessFindThread@@YAPEAU_au_proc_@@PEAU_au_thread_@@@Z ; AuProcessFindThread
	mov	QWORD PTR current_proc$[rsp], rax

; 99   : 	if (!current_proc){

	cmp	QWORD PTR current_proc$[rsp], 0
	jne	SHORT $LN8@ReadFile

; 100  : 		current_proc = AuProcessFindSubThread(current_thr);

	mov	rcx, QWORD PTR current_thr$[rsp]
	call	?AuProcessFindSubThread@@YAPEAU_au_proc_@@PEAU_au_thread_@@@Z ; AuProcessFindSubThread
	mov	QWORD PTR current_proc$[rsp], rax

; 101  : 		if (!current_proc)

	cmp	QWORD PTR current_proc$[rsp], 0
	jne	SHORT $LN7@ReadFile

; 102  : 			return 0;

	xor	eax, eax
	jmp	$LN13@ReadFile
$LN7@ReadFile:
$LN8@ReadFile:

; 103  : 	}
; 104  : 	AuVFSNode* file = current_proc->fds[fd];

	movsxd	rax, DWORD PTR fd$[rsp]
	mov	rcx, QWORD PTR current_proc$[rsp]
	mov	rax, QWORD PTR [rcx+rax*8+576]
	mov	QWORD PTR file$[rsp], rax

; 105  : 	uint64_t* aligned_buffer = (uint64_t*)buffer;

	mov	rax, QWORD PTR buffer$[rsp]
	mov	QWORD PTR aligned_buffer$[rsp], rax

; 106  : 	if (!file)

	cmp	QWORD PTR file$[rsp], 0
	jne	SHORT $LN6@ReadFile

; 107  : 		return 0;

	xor	eax, eax
	jmp	$LN13@ReadFile
$LN6@ReadFile:

; 108  : 	size_t ret_bytes = 0;

	mov	QWORD PTR ret_bytes$[rsp], 0

; 109  : 	
; 110  : 	/* every general file will contain its
; 111  : 	 * file system node as device */
; 112  : 	AuVFSNode* fsys = (AuVFSNode*)file->device;

	mov	rax, QWORD PTR file$[rsp]
	mov	rax, QWORD PTR [rax+72]
	mov	QWORD PTR fsys$[rsp], rax

; 113  : 	if (file->flags & FS_FLAG_GENERAL) {

	mov	rax, QWORD PTR file$[rsp]
	movzx	eax, WORD PTR [rax+64]
	and	eax, 4
	test	eax, eax
	je	SHORT $LN5@ReadFile

; 114  : 		ret_bytes = AuVFSNodeRead(fsys, file,aligned_buffer, length);

	mov	r9d, DWORD PTR length$[rsp]
	mov	r8, QWORD PTR aligned_buffer$[rsp]
	mov	rdx, QWORD PTR file$[rsp]
	mov	rcx, QWORD PTR fsys$[rsp]
	call	AuVFSNodeRead
	mov	QWORD PTR ret_bytes$[rsp], rax
$LN5@ReadFile:

; 115  : 	}
; 116  : 	if (file->flags & FS_FLAG_DEVICE){

	mov	rax, QWORD PTR file$[rsp]
	movzx	eax, WORD PTR [rax+64]
	and	eax, 8
	test	eax, eax
	je	SHORT $LN4@ReadFile

; 117  : 		/* devfs will handle*/
; 118  : 		if (file->read)

	mov	rax, QWORD PTR file$[rsp]
	cmp	QWORD PTR [rax+88], 0
	je	SHORT $LN3@ReadFile

; 119  : 			ret_bytes = file->read(file, file, (uint64_t*)buffer, length);

	mov	r9d, DWORD PTR length$[rsp]
	mov	r8, QWORD PTR buffer$[rsp]
	mov	rdx, QWORD PTR file$[rsp]
	mov	rcx, QWORD PTR file$[rsp]
	mov	rax, QWORD PTR file$[rsp]
	call	QWORD PTR [rax+88]
	mov	QWORD PTR ret_bytes$[rsp], rax
$LN3@ReadFile:
$LN4@ReadFile:

; 120  : 	}
; 121  : 	if ((file->flags & FS_FLAG_PIPE)) {

	mov	rax, QWORD PTR file$[rsp]
	movzx	eax, WORD PTR [rax+64]
	and	eax, 128				; 00000080H
	test	eax, eax
	je	SHORT $LN2@ReadFile

; 122  : 		/* ofcourse, pipe subsystem will handle */
; 123  : 		if (file->read)

	mov	rax, QWORD PTR file$[rsp]
	cmp	QWORD PTR [rax+88], 0
	je	SHORT $LN1@ReadFile

; 124  : 			ret_bytes = file->read(file, file, (uint64_t*)buffer, length);

	mov	r9d, DWORD PTR length$[rsp]
	mov	r8, QWORD PTR buffer$[rsp]
	mov	rdx, QWORD PTR file$[rsp]
	mov	rcx, QWORD PTR file$[rsp]
	mov	rax, QWORD PTR file$[rsp]
	call	QWORD PTR [rax+88]
	mov	QWORD PTR ret_bytes$[rsp], rax
$LN1@ReadFile:
$LN2@ReadFile:

; 125  : 	}
; 126  : 
; 127  : 	return ret_bytes;

	mov	rax, QWORD PTR ret_bytes$[rsp]
$LN13@ReadFile:

; 128  : }

	add	rsp, 88					; 00000058H
	ret	0
?ReadFile@@YA_KHPEAX_K@Z ENDP				; ReadFile
_TEXT	ENDS
; Function compile flags: /Odtpy
; File e:\xeneva project\aurora\kernel\serv\fileserv.cpp
_TEXT	SEGMENT
fd$ = 32
current_proc$ = 40
file$ = 48
current_thr$ = 56
fsys$ = 64
filename$ = 96
mode$ = 104
?OpenFile@@YAHPEADH@Z PROC				; OpenFile

; 48   : int OpenFile(char* filename, int mode) {

$LN12:
	mov	DWORD PTR [rsp+16], edx
	mov	QWORD PTR [rsp+8], rcx
	sub	rsp, 88					; 00000058H

; 49   : 	x64_cli();

	call	x64_cli

; 50   : 	AuThread* current_thr = AuGetCurrentThread();

	call	AuGetCurrentThread
	mov	QWORD PTR current_thr$[rsp], rax

; 51   : 	if (!current_thr)

	cmp	QWORD PTR current_thr$[rsp], 0
	jne	SHORT $LN9@OpenFile

; 52   : 		return 0;

	xor	eax, eax
	jmp	$LN10@OpenFile
$LN9@OpenFile:

; 53   : 	AuProcess* current_proc = AuProcessFindThread(current_thr);

	mov	rcx, QWORD PTR current_thr$[rsp]
	call	?AuProcessFindThread@@YAPEAU_au_proc_@@PEAU_au_thread_@@@Z ; AuProcessFindThread
	mov	QWORD PTR current_proc$[rsp], rax

; 54   : 	if (!current_proc) {

	cmp	QWORD PTR current_proc$[rsp], 0
	jne	SHORT $LN8@OpenFile

; 55   : 		current_proc = AuProcessFindSubThread(current_thr);

	mov	rcx, QWORD PTR current_thr$[rsp]
	call	?AuProcessFindSubThread@@YAPEAU_au_proc_@@PEAU_au_thread_@@@Z ; AuProcessFindSubThread
	mov	QWORD PTR current_proc$[rsp], rax

; 56   : 		if (!current_proc)

	cmp	QWORD PTR current_proc$[rsp], 0
	jne	SHORT $LN7@OpenFile

; 57   : 			return 0;

	xor	eax, eax
	jmp	$LN10@OpenFile
$LN7@OpenFile:
$LN8@OpenFile:

; 58   : 	}
; 59   : 
; 60   : 	AuVFSNode *fsys = AuVFSFind(filename);

	mov	rcx, QWORD PTR filename$[rsp]
	call	AuVFSFind
	mov	QWORD PTR fsys$[rsp], rax

; 61   : 	AuVFSNode* file = AuVFSOpen(filename);

	mov	rcx, QWORD PTR filename$[rsp]
	call	AuVFSOpen
	mov	QWORD PTR file$[rsp], rax

; 62   : 	if (!file) {

	cmp	QWORD PTR file$[rsp], 0
	jne	SHORT $LN6@OpenFile

; 63   : 		if (mode & FILE_OPEN_CREAT || mode & FILE_OPEN_WRITE) {

	mov	eax, DWORD PTR mode$[rsp]
	and	eax, 8
	test	eax, eax
	jne	SHORT $LN4@OpenFile
	mov	eax, DWORD PTR mode$[rsp]
	and	eax, 4
	test	eax, eax
	je	SHORT $LN5@OpenFile
$LN4@OpenFile:

; 64   : 			file = AuVFSCreateFile(fsys, filename);

	mov	rdx, QWORD PTR filename$[rsp]
	mov	rcx, QWORD PTR fsys$[rsp]
	call	AuVFSCreateFile
	mov	QWORD PTR file$[rsp], rax

; 65   : 		}
; 66   : 		else 

	jmp	SHORT $LN3@OpenFile
$LN5@OpenFile:

; 67   : 			return -1;

	mov	eax, -1
	jmp	SHORT $LN10@OpenFile
$LN3@OpenFile:
$LN6@OpenFile:

; 68   : 	}
; 69   : 
; 70   : 	/* check for last time, if any error occured */
; 71   : 	if (!file)

	cmp	QWORD PTR file$[rsp], 0
	jne	SHORT $LN2@OpenFile

; 72   : 		return -1;

	mov	eax, -1
	jmp	SHORT $LN10@OpenFile
$LN2@OpenFile:

; 73   : 
; 74   : 	int fd = AuProcessGetFileDesc(current_proc);

	mov	rcx, QWORD PTR current_proc$[rsp]
	call	?AuProcessGetFileDesc@@YAHPEAU_au_proc_@@@Z ; AuProcessGetFileDesc
	mov	DWORD PTR fd$[rsp], eax

; 75   : 	if (fd == -1)

	cmp	DWORD PTR fd$[rsp], -1
	jne	SHORT $LN1@OpenFile

; 76   : 		return -1;

	mov	eax, -1
	jmp	SHORT $LN10@OpenFile
$LN1@OpenFile:

; 77   : 	current_proc->fds[fd] = file;

	movsxd	rax, DWORD PTR fd$[rsp]
	mov	rcx, QWORD PTR current_proc$[rsp]
	mov	rdx, QWORD PTR file$[rsp]
	mov	QWORD PTR [rcx+rax*8+576], rdx

; 78   : 	return fd;

	mov	eax, DWORD PTR fd$[rsp]
$LN10@OpenFile:

; 79   : }

	add	rsp, 88					; 00000058H
	ret	0
?OpenFile@@YAHPEADH@Z ENDP				; OpenFile
_TEXT	ENDS
END
